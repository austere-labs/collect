#!/bin/bash

# quickgo - Quick Go Project Setup Script
# Usage: ./quickgo <project_name>

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Check if project name is provided
if [ -z "$1" ]; then
    echo -e "${RED}Error: Project name is required${NC}"
    echo "Usage: ./quickgo <project_name>"
    exit 1
fi

PROJECT_NAME="$1"
PROJECT_DIR="$HOME/go/src/github.com/metzben/$PROJECT_NAME"

# Check if directory already exists
if [ -d "$PROJECT_DIR" ]; then
    echo -e "${RED}Error: Directory '$PROJECT_DIR' already exists${NC}"
    exit 1
fi

echo -e "${GREEN}Creating Go project: $PROJECT_NAME${NC}"
echo -e "Location: $PROJECT_DIR"

# Create project directory
mkdir -p "$PROJECT_DIR"
cd "$PROJECT_DIR"

# Create directory structure
echo "Creating directory structure..."
mkdir -p cmd/app
mkdir -p internal
mkdir -p guides

# Create main.go (empty file)
touch cmd/app/main.go

# Create Makefile with project name
cat > Makefile << EOF
PROJECT_NAME=$PROJECT_NAME

build:
	go build -o \$(PROJECT_NAME) cmd/app/main.go

run:
	make build
	./\$(PROJECT_NAME)

test:
	go test -v -cover ./...

verify:
	go mod tidy
	go mod verify
	go vet ./...
	go fmt ./...

check:
	make verify
	make build
	make test
	rm \$(PROJECT_NAME)

EOF

# Create .gitignore
cat > .gitignore << 'EOF'
# Binaries for programs and plugins
*.exe
*.exe~
*.dll
*.so
*.dylib

# Test binary, built with `go test -c`
*.test

# Output of the go coverage tool
*.out

# Go workspace file
go.work

# Dependency directories
vendor/

# Environment variables
.env.local

# IDE specific files
.idea/
.vscode/
*.swp
*.swo

# OS specific files
.DS_Store
Thumbs.db

EOF

# Create .claude directory structure (excluding commands)
mkdir -p .claude

# Create settings.local.json
cat > .claude/settings.local.json << 'EOF'
{
  "permissions": {
    "allow": [
      "Bash(./tools/newpy:*)",
      "Bash(cat:*)",
      "Bash(uv:*)",
      "Bash(bash:*)",
      "Bash(git:*)",
      "Bash(gemini --prompt cat:*)",
      "TodoWrite",
      "Read",
      "Write"
    ],
    "defaultMode": "default"
  },
  "enableAllProjectMcpServers": true,
  "enabledMcpjsonServers": [
    "collect"
  ]
}
EOF

# Copy guide files if they exist in the source directory
SOURCE_DIR="$(dirname "$0")"
if [ -d "$SOURCE_DIR/guides" ]; then
    echo "Copying guide files..."
    cp -r "$SOURCE_DIR/guides/"*.md guides/ 2>/dev/null || echo "No guide files to copy"
fi

# Initialize go module
echo -e "\n${GREEN}Initializing Go module...${NC}"
go mod init "github.com/metzben/$PROJECT_NAME"

# Initialize git repository
echo -e "\n${GREEN}Initializing Git repository...${NC}"
git init

# Add initial files to git
git add .

echo -e "\n${GREEN}Project structure created successfully!${NC}"
echo ""
echo "Project: $PROJECT_NAME"
echo "Location: $(pwd)"
echo ""

# Ask about GitHub repository creation
echo -e "${YELLOW}Create GitHub repository? (y/N):${NC} "
read -r response

if [[ "$response" =~ ^([yY][eE][sS]|[yY])$ ]]; then
    echo -e "\n${GREEN}Creating GitHub repository...${NC}"

    # Check if gh CLI is available
    if ! command -v gh &> /dev/null; then
        echo -e "${RED}Error: GitHub CLI (gh) is not installed${NC}"
        echo "Please install it from: https://cli.github.com/"
        exit 1
    fi

    # Check if user is authenticated
    if ! gh auth status &> /dev/null; then
        echo -e "${RED}Error: Not authenticated with GitHub CLI${NC}"
        echo "Please run: gh auth login"
        exit 1
    fi

    # Create GitHub repository (private by default)
    gh repo create "$PROJECT_NAME" --private --source=. --remote=origin

    echo -e "\n${GREEN}GitHub repository created successfully!${NC}"
    echo "Repository: https://github.com/$(gh api user -q .login)/$PROJECT_NAME"
else
    echo -e "\n${YELLOW}Skipping GitHub repository creation${NC}"
fi

echo -e "\n${GREEN}Setup complete!${NC}"
echo ""
echo "Next steps:"
echo "  cd $PROJECT_NAME"
echo "  # Edit cmd/app/main.go to add your code"
echo "  make run"
echo ""
